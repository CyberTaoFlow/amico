
```
   CREATE USER pe_dumper WITH PASSWORD 'thisisatest';
   CREATE DATABASE amico_db OWNER pe_dumper;
```
> Then,
  1. copy the config file template `config.py.tmpl` to  `config.py`.
  1. update these DB details (the `db_*` parameters) accordingly in the `config.py` file under the `amico_scripts` directory.
  1. Run the `db_setup.py` script file from the main directory. This script creates all the DB tables needed by AMICO.

> After setting up the DB,
  1. Sign up at VirusTotal and get an [API Key](https://www.virustotal.com/en/documentation/public-api/#getting-started).
  1. Update the `vt_keys` parameter in the `config.py`.
  1. Choose if you would like to submit the reconstructed PE files to VirusTotal by setting the  `vt_submissions` parameter. Setting it to `None` means that you do not want to submit the reconstructed PE files to VirusTotal; if `vt_submissions = "live"` we will attempt to submit all PE files; if `vt_submissions = "manual"`, for each PE filed download, we attempt to separately re-download the file from the same URL, and if we succeed we will submit the newly downloaded file to VirusTotal.

> Please notice that the term "manual" is somewhat misleading here, in the sense that we _programmatically_ re-download the file, and submit the sample we obtain that way, rather than submitting the sample collected from live traffic. There is no explicit user action required.

> Notice also that you may set up more than one API key listed, which will be selected at random for each VirusTotal query to be made. For example, if you have two different keys, you can add them as
```
   vt_keys=["KEY1XXXXX","KEY2XXXXX"]
```
  * We now need to compile the **download reconstruction** module, called `pe_dump`, and located in the `pe_dump` directory.
```
   $ cd pe_dump/
   $ make
```
  * Run AMICO's **control scripts** first
```
   cd amico_scripts
   python start_amico.py
```
> > Notice that this will start a number of sub-processes and potentially print lots of debugging information on the `stdout`. Also, it needs to keep running if you log out. We suggest to run this within a screen multiplexer such as `screen` or `tmux`.

  * Then, we need to run the **download reconstruction** module. First copy the config file template `pe_dump/config.py.tmpl` to  `pe_dump/config.py`, and edit it to add whitelisted IP and network addresses. Then, you can run
```
   cd pe_dump
   sudo python start_pe_dump.py ethX
```

> Notice that `ethX` should be the interface that receives traffic mirroring. If the interface performs offloading, that should be disabled. To do so, you may use
```
   cd utils
   sudo ./turn_offload_off.sh
```

> By default, all client IP addresses will be anonymized. To store the **true client IPs** into the download history database, `pe_dump` should be run with the `-A` command line flag, which turns off the on-the-fly source IP anonymization. To obtain more information about command line parameters for `pe_dump`, please refer to the `pe_dump/README` file, or to
```
   ./pe_dump -h
```

> You can use this information to tweak the arguments passed to `pe_dump` in `start_pe_dump.py` script. If you do decide to play with the parameters for `pe_dump`, we suggest to also increase the max number of entries in the LRU cache for TCP flows, using the -L option.

> Also, **you can start more than one `pe_dump` process in parallel** on different interfaces (one per network interface); AMICO will seamlessly collect PE files from all of such processes.

> In `pe_dump/config.py`, the `manual_download_ip` is used to exclude traffic generated by the "manual"  downloads, by adding the IP of the local machine or SOCKS proxy to the filter. Whereas `whitelist_subnets` can be used to reduce the amount of traffic processed by whitelisting popular destination networks such as Google, Facebook, Microsoft, etc.


  * To stop AMICO completely, you can first SIGTERM each `pe_dump` process you previously started with `start_pe_dump.py`, and SIGTERM `start_amico.py`